<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.quali.takenQualiExam.model.dao.TakenQualiExamMapper">


						
	<resultMap id="takenTechQualiExam" type="takenQualiExam">
		<id column="EXAM_NO" property="examNo" />
	    <result column="EXAM_START_DATE" property="examStartDate" />
	    <result column="EXAM_FINAL_DATE" property="examFinalDate" />
	    <result column="RECEPTION_START_DATE" property="receptionStartDate" />
	    <result column="RECEPTION_END_DATE" property="receptionEndDate" />
	    <result column="OPINION_START_DATE" property="opinionStartDate" />
	    <result column="OPINION_END_DATE" property="opinionEndDate" />
	    <collection property="qualificationExam" ofType="techQualificationExam">
	    	<id column="EXAM_TYPE_NO" property="examTypeNo" />
    		<result column="QUALIFICATION_RANK" property="qualificationRank" />
    		<collection property="technicalQualification" ofType="technicalQualification">
    			<id column="QUALIFICATION_NO" property="qualificationNo"/>
				<result column="QUALIFICATION_NAME" property="qualificationName"/>
				<result column="STATUS" property="status"/>
				<result column="REQUIRED_RANK" property="requiredRank"/>
				<collection property="techCategory" ofType="techCategory">
					<id column="CATEGORY_NO" property="categoryNo"/>
					<result column="CATEGORY_NAME" property="categoryName"/>
					<collection property="technicalField" ofType="technicalField">
						<id column="FIELD_NO" property="fieldNo"/>
						<result column="FIELD_NAME" property="fieldName"/>
						<collection property="typeQualification" ofType="typeQualification">
							<id column="QUALIFICATION_CODE" property="qualificationCode"/>
							<result column="QUALIFICATION_TYPE" property="qualificationType"/>
						</collection>
					</collection>
				</collection>
    		</collection>
	    </collection>
	</resultMap>
	
	<resultMap id="techQualificationExam" type="techQualificationExam">
    	<id column="EXAM_TYPE_NO" property="examTypeNo" />
   		<result column="QUALIFICATION_RANK" property="qualificationRank" />
   		<collection property="technicalQualification" ofType="technicalQualification">
   			<id column="QUALIFICATION_NO" property="qualificationNo"/>
			<result column="QUALIFICATION_NAME" property="qualificationName"/>
			<result column="STATUS" property="status"/>
			<result column="REQUIRED_RANK" property="requiredRank"/>
			<collection property="techCategory" ofType="techCategory">
				<id column="CATEGORY_NO" property="categoryNo"/>
				<result column="CATEGORY_NAME" property="categoryName"/>
				<collection property="technicalField" ofType="technicalField">
					<id column="FIELD_NO" property="fieldNo"/>
					<result column="FIELD_NAME" property="fieldName"/>
					<collection property="typeQualification" ofType="typeQualification">
						<id column="QUALIFICATION_CODE" property="qualificationCode"/>
						<result column="QUALIFICATION_TYPE" property="qualificationType"/>
					</collection>
				</collection>
			</collection>
   		</collection>
	</resultMap>
	
	<resultMap id="takenProQualiExam" type="takenQualiExam">
		<id column="EXAM_NO" property="examNo" />
	    <result column="EXAM_START_DATE" property="examStartDate" />
	    <result column="EXAM_FINAL_DATE" property="examFinalDate" />
	    <result column="RECEPTION_START_DATE" property="receptionStartDate" />
	    <result column="RECEPTION_END_DATE" property="receptionEndDate" />
	    <result column="OPINION_START_DATE" property="opinionStartDate" />
	    <result column="OPINION_END_DATE" property="opinionEndDate" />
	    <collection property="qualificationExam" ofType="proQualificationExam">
	    	<id column="EXAM_TYPE_NO" property="examTypeNo" />
    		<result column="QUALIFICATION_RANK" property="qualificationRank" />
    		<collection property="profesionalQualification" ofType="profesionalQualification">
    			<id column="QUALIFICATION_NO" property="qualificationNo"/>
				<result column="QUALIFICATION_NAME" property="qualificationName"/>
				<result column="STATUS" property="status"/>
				<result column="REQUIRED_RANK" property="requiredRank"/>
				<collection property="profesionalDept" ofType="profesionalDept">
					<id column="CATEGORY_NO" property="categoryNo"/>
					<result column="RELEVANT_DEPARTMENT" property="relevantDepartment"/>
					<collection property="typeQualification" ofType="typeQualification">
						<id column="QUALIFICATION_CODE" property="qualificationCode"/>
						<result column="QUALIFICATION_TYPE" property="qualificationType"/>
					</collection>
				</collection>
    		</collection>
	    </collection>
	</resultMap>
	
	<resultMap id="proQualificationExam" type="proQualificationExam">
    	<id column="EXAM_TYPE_NO" property="examTypeNo" />
   		<result column="QUALIFICATION_RANK" property="qualificationRank" />
   		<collection property="profesionalQualification" ofType="profesionalQualification">
   			<id column="QUALIFICATION_NO" property="qualificationNo"/>
			<result column="QUALIFICATION_NAME" property="qualificationName"/>
			<result column="STATUS" property="status"/>
			<result column="REQUIRED_RANK" property="requiredRank"/>
			<collection property="profesionalDept" ofType="profesionalDept">
				<id column="CATEGORY_NO" property="categoryNo"/>
				<result column="RELEVANT_DEPARTMENT" property="relevantDepartment"/>
				<collection property="typeQualification" ofType="typeQualification">
					<id column="QUALIFICATION_CODE" property="qualificationCode"/>
					<result column="QUALIFICATION_TYPE" property="qualificationType"/>
				</collection>
			</collection>
   		</collection>
    </resultMap>
	
	
	<select id="findTechExamNoByNameAndRank" parameterType="techQualificationExam" resultMap="techQualificationExam">
	SELECT EXAM_TYPE_NO, 
	QUALIFICATION_RANK, 
    TB_QUALIFICATION_EXAM.QUALIFICATION_NO,
    QUALIFICATION_NAME, 
    STATUS, 
    REQUIRED_RANK, 
    TB_TECHNICAL_QUALIFICATION.CATEGORY_NO, 
    TB_QUALI_TECH_CATEGORY.CATEGORY_NAME, 
    TB_QUALI_TECH_CATEGORY.FIELD_NO, 
    TB_QUALI_TECHNICAL_FIELD.FIELD_NAME, 
    TB_QUALI_TECHNICAL_FIELD.QUALIFICATION_CODE, 
    QUALIFICATION_TYPE 
    FROM TB_QUALIFICATION_EXAM JOIN TB_TECHNICAL_QUALIFICATION ON (TB_TECHNICAL_QUALIFICATION.QUALIFICATION_NO = TB_QUALIFICATION_EXAM.QUALIFICATION_NO) 
    JOIN TB_QUALI_TECH_CATEGORY ON (TB_TECHNICAL_QUALIFICATION.CATEGORY_NO = TB_QUALI_TECH_CATEGORY.CATEGORY_NO) 
    JOIN TB_QUALI_TECHNICAL_FIELD ON (TB_QUALI_TECHNICAL_FIELD.FIELD_NO = TB_QUALI_TECH_CATEGORY.FIELD_NO) 
    JOIN TB_TYPE_QUALIFICATION ON (TB_TYPE_QUALIFICATION.QUALIFICATION_CODE = TB_QUALI_TECHNICAL_FIELD.QUALIFICATION_CODE) 
    WHERE QUALIFICATION_RANK = #{qualificationRank} 
    AND TB_QUALIFICATION_EXAM.QUALIFICATION_NO = #{technicalQualification.qualificationNo}
	</select>
	
	<select id="findProExamByNameAndRank" parameterType="proQualificationExam" resultMap="proQualificationExam">
	SELECT 
    EXAM_TYPE_NO, 
	QUALIFICATION_RANK, 
    TB_QUALIFICATION_EXAM.QUALIFICATION_NO,  
    QUALIFICATION_NAME, 
	STATUS, 
	REQUIRED_RANK, 
    TB_PROFESIONAL_QUALIFICATION.CATEGORY_NO, 
    RELEVANT_DEPARTMENT, 
	TB_QUALI_PROFESIONAL_DEPT.QUALIFICATION_CODE, 
    QUALIFICATION_TYPE 
    FROM 
    TB_QUALIFICATION_EXAM 
    JOIN TB_PROFESIONAL_QUALIFICATION ON (TB_QUALIFICATION_EXAM.QUALIFICATION_NO = TB_PROFESIONAL_QUALIFICATION.QUALIFICATION_NO) 
    JOIN TB_QUALI_PROFESIONAL_DEPT ON (TB_QUALI_PROFESIONAL_DEPT.CATEGORY_NO = TB_PROFESIONAL_QUALIFICATION.CATEGORY_NO) 
    JOIN TB_TYPE_QUALIFICATION ON (TB_TYPE_QUALIFICATION.QUALIFICATION_CODE = TB_QUALI_PROFESIONAL_DEPT.QUALIFICATION_CODE) 
    WHERE QUALIFICATION_RANK = #{qualificationRank} AND QUALIFICATION_NAME = #{profesionalQualification.qualificationName}
	</select>
	
	<insert id="insertTakenTechExam" parameterType="map">
		INSERT INTO TB_TAKEN_QUALI_EXAM (
		EXAM_NO,
	EXAM_START_DATE,
	EXAM_FINAL_DATE,
	RECEPTION_START_DATE,
	RECEPTION_END_DATE,
	OPINION_START_DATE,
	OPINION_END_DATE,
	EXAM_TYPE_NO) 
	VALUES (SEQ_TQE_NO.NEXTVAL, TO_DATE(#{takenQualiExam.examStartDate}, 'YYYY-MM-DD'), 
    TO_DATE(#{takenQualiExam.examFinalDate}, 'YYYY-MM-DD'), 
    TO_DATE(#{takenQualiExam.receptionStartDate}, 'YYYY-MM-DD'), 
    TO_DATE(#{takenQualiExam.receptionEndDate}, 'YYYY-MM-DD'), 
    TO_DATE(#{takenQualiExam.opinionStartDate}, 'YYYY-MM-DD'), 
    TO_DATE(#{takenQualiExam.opinionEndDate}, 'YYYY-MM-DD'), #{examTypeNo})
	</insert>
	
	<select id="takenProQualiExamList" resultMap="takenProQualiExam">
	SELECT 
    EXAM_NO,
    TO_CHAR(EXAM_START_DATE, 'YYYY-MM-DD') AS EXAM_START_DATE,
    TO_CHAR(EXAM_FINAL_DATE, 'YYYY-MM-DD') AS EXAM_FINAL_DATE,
    TO_CHAR(RECEPTION_START_DATE, 'YYYY-MM-DD') AS RECEPTION_START_DATE,
    TO_CHAR(RECEPTION_END_DATE, 'YYYY-MM-DD') AS RECEPTION_END_DATE,
    TO_CHAR(OPINION_START_DATE, 'YYYY-MM-DD') AS OPINION_START_DATE,
    TO_CHAR(OPINION_END_DATE, 'YYYY-MM-DD') AS OPINION_END_DATE,
    TB_TAKEN_QUALI_EXAM.EXAM_TYPE_NO, 
    TB_QUALIFICATION_EXAM.QUALIFICATION_RANK,
    TB_QUALIFICATION_EXAM.QUALIFICATION_CODE,
    TB_QUALIFICATION_EXAM.QUALIFICATION_NO, 
    TB_PROFESIONAL_QUALIFICATION.QUALIFICATION_NAME,
    TB_PROFESIONAL_QUALIFICATION.STATUS,
    TB_PROFESIONAL_QUALIFICATION.REQUIRED_RANK,
    TB_PROFESIONAL_QUALIFICATION.CATEGORY_NO, 
    TB_QUALI_PROFESIONAL_DEPT.RELEVANT_DEPARTMENT,
    TB_QUALI_PROFESIONAL_DEPT.QUALIFICATION_CODE,  
    TB_TYPE_QUALIFICATION.QUALIFICATION_TYPE 
    FROM TB_TAKEN_QUALI_EXAM 
    JOIN TB_QUALIFICATION_EXAM ON (TB_TAKEN_QUALI_EXAM.EXAM_TYPE_NO = TB_QUALIFICATION_EXAM.EXAM_TYPE_NO) 
    JOIN TB_PROFESIONAL_QUALIFICATION ON (TB_PROFESIONAL_QUALIFICATION.QUALIFICATION_NO = TB_QUALIFICATION_EXAM.QUALIFICATION_NO) 
    JOIN TB_QUALI_PROFESIONAL_DEPT ON (TB_QUALI_PROFESIONAL_DEPT.CATEGORY_NO = TB_PROFESIONAL_QUALIFICATION.CATEGORY_NO) 
    JOIN TB_TYPE_QUALIFICATION ON (TB_TYPE_QUALIFICATION.QUALIFICATION_CODE = TB_QUALI_PROFESIONAL_DEPT.QUALIFICATION_CODE) 
    WHERE SYSDATE BETWEEN RECEPTION_START_DATE AND RECEPTION_END_DATE 
    OR SYSDATE BETWEEN EXAM_START_DATE AND EXAM_FINAL_DATE 
    ORDER BY EXAM_NO DESC
	</select>
	
	<select id="takenTechQualiExam" resultMap="takenTechQualiExam">
	SELECT
    EXAM_NO,
    TO_CHAR(EXAM_START_DATE, 'YYYY-MM-DD') AS EXAM_START_DATE,
    TO_CHAR(EXAM_FINAL_DATE, 'YYYY-MM-DD') AS EXAM_FINAL_DATE,
    TO_CHAR(RECEPTION_START_DATE, 'YYYY-MM-DD') AS RECEPTION_START_DATE,
    TO_CHAR(RECEPTION_END_DATE, 'YYYY-MM-DD') AS RECEPTION_END_DATE,
    TO_CHAR(OPINION_START_DATE, 'YYYY-MM-DD') AS OPINION_START_DATE,
    TO_CHAR(OPINION_END_DATE, 'YYYY-MM-DD') AS OPINION_END_DATE,
    TB_TAKEN_QUALI_EXAM.EXAM_TYPE_NO, 
    QUALIFICATION_RANK,
    TB_QUALIFICATION_EXAM.QUALIFICATION_NO, 
    QUALIFICATION_NAME,
    STATUS,
    REQUIRED_RANK,
    TB_TECHNICAL_QUALIFICATION.CATEGORY_NO, 
    CATEGORY_NAME,
    TB_QUALI_TECH_CATEGORY.FIELD_NO, 
    FIELD_NAME, 
	TB_QUALI_TECHNICAL_FIELD.QUALIFICATION_CODE, 
    QUALIFICATION_TYPE
    FROM
    TB_TAKEN_QUALI_EXAM 
    JOIN TB_QUALIFICATION_EXAM ON (TB_QUALIFICATION_EXAM.EXAM_TYPE_NO = TB_TAKEN_QUALI_EXAM.EXAM_TYPE_NO) 
    JOIN TB_TECHNICAL_QUALIFICATION ON (TB_QUALIFICATION_EXAM.QUALIFICATION_NO = TB_TECHNICAL_QUALIFICATION.QUALIFICATION_NO)
    JOIN TB_QUALI_TECH_CATEGORY ON (TB_TECHNICAL_QUALIFICATION.CATEGORY_NO = TB_QUALI_TECH_CATEGORY.CATEGORY_NO)
    JOIN TB_QUALI_TECHNICAL_FIELD ON (TB_QUALI_TECH_CATEGORY.FIELD_NO = TB_QUALI_TECHNICAL_FIELD.FIELD_NO) 
    JOIN TB_TYPE_QUALIFICATION ON (TB_QUALI_TECHNICAL_FIELD.QUALIFICATION_CODE = TB_TYPE_QUALIFICATION.QUALIFICATION_CODE) 
    WHERE SYSDATE BETWEEN RECEPTION_START_DATE AND RECEPTION_END_DATE 
    OR SYSDATE BETWEEN EXAM_START_DATE AND EXAM_FINAL_DATE 
    ORDER BY EXAM_NO DESC
	</select>
	
	<select id="getRoundOfExam" parameterType ="takenQualiExam" resultType="_int">
	SELECT 
    COUNT(*) 
    FROM TB_TAKEN_QUALI_EXAM 
    JOIN TB_QUALIFICATION_EXAM ON (TB_TAKEN_QUALI_EXAM.EXAM_TYPE_NO = TB_QUALIFICATION_EXAM.EXAM_TYPE_NO) 
    WHERE TB_TAKEN_QUALI_EXAM.EXAM_TYPE_NO = #{qualificationExam.examTypeNo} AND EXAM_START_DATE &lt;= TO_DATE(#{examStartDate}, 'YYYY-MM-DD') 
	</select> 
	
	
	
	
</mapper>